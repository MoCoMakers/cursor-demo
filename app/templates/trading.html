<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bayesian Trading Dashboard - Investment Portfolio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .strategy-card {
            transition: transform 0.2s;
        }
        .strategy-card:hover {
            transform: translateY(-2px);
        }
        .signal-buy { color: #28a745; }
        .signal-sell { color: #dc3545; }
        .signal-hold { color: #6c757d; }
        .performance-positive { color: #28a745; }
        .performance-negative { color: #dc3545; }
        .chart-container {
            height: 300px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-line me-2"></i>Investment Portfolio
            </a>
            <div class="navbar-nav">
                <a class="nav-link" href="/">Home</a>
                <a class="nav-link" href="/dashboard">Dashboard</a>
                <a class="nav-link active" href="/trading">Trading</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-brain me-2"></i>Bayesian Trading Dashboard
                </h1>
                <p class="lead">AI-powered investment strategies using Bayesian inference and PyMC3</p>
            </div>
        </div>

        <!-- Strategy Management -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-plus me-2"></i>Create New Strategy</h5>
                    </div>
                    <div class="card-body">
                        <form id="strategyForm">
                            <div class="mb-3">
                                <label for="strategyName" class="form-label">Strategy Name</label>
                                <input type="text" class="form-control" id="strategyName" required>
                            </div>
                            <div class="mb-3">
                                <label for="strategySymbol" class="form-label">Symbol</label>
                                <input type="text" class="form-control" id="strategySymbol" placeholder="AAPL" required>
                            </div>
                            <div class="mb-3">
                                <label for="strategyDescription" class="form-label">Description</label>
                                <textarea class="form-control" id="strategyDescription" rows="3"></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="confidenceThreshold" class="form-label">Confidence Threshold</label>
                                        <input type="number" class="form-control" id="confidenceThreshold" value="0.6" step="0.1" min="0" max="1">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="positionSize" class="form-label">Position Size (%)</label>
                                        <input type="number" class="form-control" id="positionSize" value="10" step="1" min="1" max="50">
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Create Strategy
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-info-circle me-2"></i>How It Works</h5>
                    </div>
                    <div class="card-body">
                        <h6>Statistical Investment Strategy</h6>
                        <ul class="list-unstyled">
                            <li><i class="fas fa-chart-line text-primary me-2"></i>Analyzes historical price data</li>
                            <li><i class="fas fa-brain text-success me-2"></i>Uses statistical analysis for predictions</li>
                            <li><i class="fas fa-robot text-info me-2"></i>Predicts future returns with uncertainty</li>
                            <li><i class="fas fa-trade text-warning me-2"></i>Generates buy/sell signals</li>
                            <li><i class="fas fa-paper-plane text-secondary me-2"></i>Executes paper trades via Alpaca API</li>
                        </ul>
                        <div class="alert alert-info">
                            <small>
                                <strong>Note:</strong> This system uses paper trading for risk-free testing. 
                                Real money is not at risk.
                            </small>
                        </div>
                        <hr>
                        <button class="btn btn-outline-primary btn-sm" onclick="createSampleData()">
                            <i class="fas fa-database me-2"></i>Create Sample Data
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Strategies -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Active Strategies</h5>
                    </div>
                    <div class="card-body">
                        <div id="strategiesList">
                            <!-- Strategies will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Trades -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i>Recent Trades</h5>
                    </div>
                    <div class="card-body">
                        <div id="tradesList">
                            <!-- Trades will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Modal -->
    <div class="modal fade" id="analysisModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Strategy Analysis</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="analysisResults">
                        <!-- Analysis results will be loaded here -->
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Market Data (100 Days)</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="marketChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>Daily Returns</h6>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="returnsChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load strategies on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStrategies();
            loadTrades();
        });

        // Strategy form submission
        document.getElementById('strategyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            createStrategy();
        });

        function createStrategy() {
            const formData = {
                name: document.getElementById('strategyName').value,
                symbol: document.getElementById('strategySymbol').value.toUpperCase(),
                description: document.getElementById('strategyDescription').value,
                confidence_threshold: parseFloat(document.getElementById('confidenceThreshold').value),
                position_size: parseFloat(document.getElementById('positionSize').value) / 100,
                portfolio_id: 1 // Default to first portfolio
            };

            fetch('/api/strategies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Strategy created successfully!');
                    document.getElementById('strategyForm').reset();
                    loadStrategies();
                } else {
                    alert('Error creating strategy: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating strategy');
            });
        }

        function loadStrategies() {
            fetch('/api/strategies')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayStrategies(data.strategies);
                }
            })
            .catch(error => {
                console.error('Error loading strategies:', error);
            });
        }

        function displayStrategies(strategies) {
            const container = document.getElementById('strategiesList');
            if (strategies.length === 0) {
                container.innerHTML = '<p class="text-muted">No strategies created yet.</p>';
                return;
            }

            container.innerHTML = strategies.map(strategy => `
                <div class="card strategy-card mb-3">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <h6 class="card-title">${strategy.name}</h6>
                                <p class="card-text text-muted">${strategy.description || 'No description'}</p>
                                <div class="row">
                                    <div class="col-md-3">
                                        <small class="text-muted">Symbol</small><br>
                                        <strong>${strategy.symbol}</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Win Rate</small><br>
                                        <strong class="performance-${strategy.win_rate > 50 ? 'positive' : 'negative'}">${strategy.win_rate.toFixed(1)}%</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">Total Trades</small><br>
                                        <strong>${strategy.total_trades}</strong>
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">P&L</small><br>
                                        <strong class="performance-${strategy.total_pnl >= 0 ? 'positive' : 'negative'}">$${strategy.total_pnl.toFixed(2)}</strong>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="analyzeStrategy(${strategy.id})">
                                    <i class="fas fa-chart-line me-1"></i>Analyze
                                </button>
                                <button class="btn btn-success btn-sm me-2" onclick="runStrategy(${strategy.id})">
                                    <i class="fas fa-play me-1"></i>Run
                                </button>
                                <button class="btn btn-${strategy.is_active ? 'warning' : 'secondary'} btn-sm" onclick="toggleStrategy(${strategy.id}, ${strategy.is_active})">
                                    <i class="fas fa-${strategy.is_active ? 'pause' : 'play'} me-1"></i>${strategy.is_active ? 'Pause' : 'Start'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function analyzeStrategy(strategyId) {
            fetch(`/api/strategies/${strategyId}/analyze`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAnalysis(data.strategy, data.market_data, data.returns_data, data.analysis);
                } else {
                    alert('Error analyzing strategy: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error analyzing strategy');
            });
        }

        function runStrategy(strategyId) {
            fetch(`/api/strategies/${strategyId}/run`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Strategy executed successfully!');
                    loadStrategies();
                    loadTrades();
                } else {
                    alert('Error running strategy: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error running strategy');
            });
        }

        function showAnalysis(strategy, marketData, returnsData, analysis) {
            const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
            const container = document.getElementById('analysisResults');
            
            const signalClass = analysis.action === 'buy' ? 'signal-buy' : 
                              analysis.action === 'sell' ? 'signal-sell' : 'signal-hold';
            
            container.innerHTML = `
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Strategy Details</h6>
                        <p><strong>Name:</strong> ${strategy.name}</p>
                        <p><strong>Symbol:</strong> ${strategy.symbol}</p>
                        <p><strong>Confidence Threshold:</strong> ${(strategy.confidence_threshold * 100).toFixed(1)}%</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Trading Signal</h6>
                        <p><strong>Action:</strong> <span class="${signalClass}">${analysis.action.toUpperCase()}</span></p>
                        <p><strong>Predicted Return:</strong> <span class="performance-${analysis.predicted_return >= 0 ? 'positive' : 'negative'}">${analysis.predicted_return.toFixed(4)}</span></p>
                        <p><strong>Confidence:</strong> ${analysis.confidence.toFixed(4)}</p>
                        <p><strong>Reasoning:</strong> ${analysis.reasoning}</p>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6>Average Return</h6>
                                <h4 class="performance-${analysis.avg_return >= 0 ? 'positive' : 'negative'}">${analysis.avg_return}%</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6>Volatility</h6>
                                <h4>${analysis.volatility}%</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h6>Trend</h6>
                                <h4 class="performance-${analysis.trend >= 0 ? 'positive' : 'negative'}">${analysis.trend.toFixed(4)}</h4>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Create charts after modal is shown
            modal.show();
            
            // Wait for modal to be fully shown before creating charts
            setTimeout(() => {
                createMarketChart(marketData);
                createReturnsChart(returnsData);
            }, 300);
        }

        function createMarketChart(marketData) {
            const ctx = document.getElementById('marketChart').getContext('2d');
            
            const labels = marketData.map(item => item.date);
            const closePrices = marketData.map(item => item.close);
            const highPrices = marketData.map(item => item.high);
            const lowPrices = marketData.map(item => item.low);
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Close Price',
                        data: closePrices,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'High Price',
                        data: highPrices,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        tension: 0.1
                    }, {
                        label: 'Low Price',
                        data: lowPrices,
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Market Data (OHLC)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function createReturnsChart(returnsData) {
            const ctx = document.getElementById('returnsChart').getContext('2d');
            
            const labels = returnsData.map(item => item.date);
            const returns = returnsData.map(item => item.return);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Returns (%)',
                        data: returns,
                        backgroundColor: returns.map(r => r >= 0 ? 'rgba(40, 167, 69, 0.7)' : 'rgba(220, 53, 69, 0.7)'),
                        borderColor: returns.map(r => r >= 0 ? '#28a745' : '#dc3545'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Returns'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function loadTrades() {
            fetch('/api/trades')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayTrades(data.trades);
                }
            })
            .catch(error => {
                console.error('Error loading trades:', error);
            });
        }

        function displayTrades(trades) {
            const container = document.getElementById('tradesList');
            if (trades.length === 0) {
                container.innerHTML = '<p class="text-muted">No trades executed yet.</p>';
                return;
            }

            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Symbol</th>
                                <th>Action</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Predicted Return</th>
                                <th>Confidence</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${trades.map(trade => `
                                <tr>
                                    <td>${new Date(trade.timestamp).toLocaleString()}</td>
                                    <td><strong>${trade.symbol}</strong></td>
                                    <td><span class="signal-${trade.side}">${trade.side.toUpperCase()}</span></td>
                                    <td>${trade.quantity.toFixed(2)}</td>
                                    <td>$${trade.price.toFixed(2)}</td>
                                    <td class="performance-${trade.predicted_return >= 0 ? 'positive' : 'negative'}">${trade.predicted_return.toFixed(4)}</td>
                                    <td>${trade.confidence.toFixed(4)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function createSampleData() {
            fetch('/api/sample-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Sample data created successfully! You can now test the trading strategies.');
                    loadStrategies();
                    loadTrades();
                } else {
                    alert('Error creating sample data: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating sample data');
            });
        }
    </script>
</body>
</html> 